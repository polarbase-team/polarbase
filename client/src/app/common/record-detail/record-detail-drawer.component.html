<ng-template #fieldTmpl let-field="field" let-first="first">
  <div class="grid grid-cols-3 w-full gap-12">
    <label [attr.for]="field.name" class="col-span-1">
      <div class="flex items-center gap-2">
        @if (field.params.isPrimary) {
          <i class="icon icon-key" style="color: var(--p-primary-color)"></i>
        }
        <p class="font-medium">{{ field.name }}</p>
      </div>
      <p class="text-surface-400 text-sm">{{ field.params.rawType }}</p>
    </label>
    @switch (field.dataType) {
      @case (DataType.Text) {
        <input
          pInputText
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [(ngModel)]="internalData[field.name]"
          [readonly]="viewOnly()"
          class="col-span-2"
          placeholder="Input here..."
        />
      }
      @case (DataType.LongText) {
        <textarea
          pTextarea
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [(ngModel)]="internalData[field.name]"
          [readonly]="viewOnly()"
          rows="5"
          class="col-span-2"
          placeholder="Input here..."
        ></textarea>
      }
      @case (DataType.Integer) {
        <p-inputnumber
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [(ngModel)]="internalData[field.name]"
          [useGrouping]="false"
          [readonly]="viewOnly()"
          class="col-span-2"
          placeholder="Input here..."
        />
      }
      @case (DataType.Number) {
        <p-inputnumber
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [(ngModel)]="internalData[field.name]"
          [useGrouping]="false"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="5"
          [readonly]="viewOnly()"
          class="col-span-2"
          placeholder="Input here..."
        />
      }
      @case (DataType.Dropdown) {
        <p-select
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [options]="field.options"
          [readonly]="viewOnly()"
          class="col-span-2"
          placeholder="Select here..."
        />
      }
      @case (DataType.Checkbox) {
        <div class="col-span-2">
          <p-checkbox
            [attr.inputId]="field.name"
            [pAutoFocus]="first"
            [(ngModel)]="internalData[field.name]"
            [readonly]="viewOnly()"
            [binary]="true"
            size="large"
          />
        </div>
      }
      @case (DataType.Date) {
        <p-datepicker
          [attr.inputId]="field.name"
          [pAutoFocus]="first"
          [(ngModel)]="internalData[field.name]"
          [readonlyInput]="viewOnly()"
          [disabled]="viewOnly()"
          class="flex flex-col col-span-2"
          appendTo="body"
          placeholder="Select here..."
        />
      }
      @case (DataType.JSON) {
        <div class="relative col-span-2">
          <textarea
            pTextarea
            [attr.inputId]="field.name"
            [pAutoFocus]="first"
            [ngModel]="internalData[field.name] | json"
            [readonly]="viewOnly()"
            rows="5"
            cols="30"
            class="w-full"
            placeholder="Input here..."
          ></textarea>
          <div
            class="absolute top-1 right-1 hover:bg-surface-50 text-surface-500 cursor-pointer w-8 h-8 rounded-md flex items-center justify-center"
            (click)="openJSONEditor(field)"
          >
            <i class="icon icon-maximize-2"></i>
          </div>
        </div>
      }
    }
  </div>
</ng-template>

<p-drawer
  [(visible)]="visible"
  position="right"
  [header]="mode() === 'view' ? 'View Record' : mode() === 'edit' ? 'Edit Record' : 'Add Record'"
  [modal]="false"
  styleClass="!w-150 custom-drawer"
  (onShow)="onShow()"
  (onHide)="onHide()"
>
  <ng-template #content>
    <p-toast />
    <rich-text-editor-drawer />
    <json-editor-drawer
      [(visible)]="visibleJSONEditor"
      [(value)]="editingJSONText"
      (saved)="internalData[editingJSONField?.name] = $event"
    />
    <div class="flex flex-col gap-12">
      @for (field of requiredFields(); let first = $first; track field.name) {
        <ng-container *ngTemplateOutlet="fieldTmpl; context: { field, first }" />
      }
    </div>
    <p-divider class="!my-10" />
    <div class="mb-10">
      <p class="text-xl font-medium">Optional Fields</p>
      <p class="text-surface-500">These are columns that do not need any value</p>
    </div>
    <div class="flex flex-col gap-12">
      @for (field of optionalFields(); track field.name) {
        <ng-container *ngTemplateOutlet="fieldTmpl; context: { field }" />
      }
    </div>
  </ng-template>
  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (click)="visible.set(false)" />
      <p-button label="Save" (click)="save()" />
    </div>
  </ng-template>
</p-drawer>
