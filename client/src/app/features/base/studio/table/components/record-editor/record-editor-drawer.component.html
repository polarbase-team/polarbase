<ng-template #fieldTmpl let-field="field">
  <div class="grid grid-cols-3 w-full gap-12">
    @let uiName = field.params.presentation?.uiName || field.name;
    <label [attr.for]="uiName" class="col-span-1">
      <div class="flex items-center gap-2 overflow-hidden">
        @if (field.params.primary) {
          <i class="icon icon-key rotate-45" style="color: var(--p-primary-color)"></i>
        } @else {
          <i [class]="`${field.icon}`"></i>
        }
        <span class="font-medium text-sm white-space-nowrap truncate" [attr.title]="uiName">
          {{ uiName }}
          @if (field.params.presentation?.uiName) {
            <span class="text-xs text-surface-500">{{ field.name }}</span>
          }
        </span>
      </div>
      <p class="text-surface-500 text-xs">
        @if (field.description) {
          {{ field.description }}
        } @else {
          <i>No description</i>
        }
      </p>
    </label>
    <div class="col-span-2">
      @if (field.params.primary) {
        <input
          pInputText
          [ngModel]="updatedRecord[field.name]"
          [readonly]="true"
          placeholder="generated by system"
          fluid
        />
      } @else {
        @switch (field.dataType) {
          @case (DataType.Text) {
            <text-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.LongText) {
            <long-text-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Integer) {
            <integer-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Number) {
            <number-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Select) {
            <select-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.MultiSelect) {
            <multi-select-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Checkbox) {
            <checkbox-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Date) {
            <date-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Email) {
            <email-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Url) {
            <url-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.JSON) {
            <json-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.GeoPoint) {
            <geo-point-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Reference) {
            <reference-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.Attachment) {
            <attachment-field-editor
              [field]="field"
              [(data)]="updatedRecord[field.name]"
              (dataChange)="isDataChanged = true"
              [viewOnly]="viewOnly()"
              [label]="false"
            />
          }
          @case (DataType.AutoNumber) {
            <p-inputnumber
              [ngModel]="updatedRecord[field.name]"
              [readonly]="true"
              placeholder="generated by system"
              fluid
            />
          }
          @case (DataType.AutoDate) {
            <input
              pInputText
              [ngModel]="updatedRecord[field.name] | dateFormat"
              [readonly]="true"
              placeholder="generated by system"
              fluid
            />
          }
          @default {
            <input
              pInputText
              [ngModel]="updatedRecord[field.name]"
              [readonly]="true"
              placeholder="N/A"
              fluid
            />
          }
        }
      }
    </div>
  </div>
</ng-template>

<p-confirmdialog appendTo="body" styleClass="max-w-md" />

<p-drawer
  [visible]="visible()"
  position="right"
  [header]="mode() === 'view' ? 'View Record' : mode() === 'edit' ? 'Edit Record' : 'Add Record'"
  styleClass="!w-150 custom-drawer"
  (onShow)="onShow()"
  (onHide)="onHide()"
>
  <ng-template #content>
    <p-toast />
    <div class="p-5">
      <div class="flex flex-col gap-10">
        @for (field of requiredFields(); track field.name) {
          <ng-container *ngTemplateOutlet="fieldTmpl; context: { field }" />
        }
      </div>
    </div>
    <p-divider />
    <div class="p-5">
      <div class="mb-10">
        <p class="font-medium">Optional Fields</p>
        <p class="text-surface-500 text-sm">These are columns that do not need any value</p>
      </div>
      <div class="flex flex-col gap-10">
        @for (field of optionalFields(); track field.name) {
          <ng-container *ngTemplateOutlet="fieldTmpl; context: { field }" />
        }
      </div>
    </div>
  </ng-template>
  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (click)="visible.set(false)" />
      <p-button label="Save" [loading]="isSaving()" (click)="save()" />
    </div>
  </ng-template>
</p-drawer>
