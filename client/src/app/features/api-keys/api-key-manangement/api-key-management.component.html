<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-drawer
  [(visible)]="isCreationMode"
  position="right"
  header="Add key"
  styleClass="!w-150 custom-drawer"
  (onHide)="reset()"
>
  <ng-template #content>
    <form id="apiKeyForm" #apiKeyForm="ngForm" (ngSubmit)="onApiKeyFormSubmit()">
      <div class="p-5">
        <div class="grid grid-cols-3 w-full gap-12">
          <label for="name" class="col-span-1">
            <p class="font-medium text-sm">Name</p>
          </label>
          <div class="flex flex-col gap-1 col-span-2">
            <input
              pInputText
              id="name"
              name="keyName"
              [pAutoFocus]="true"
              [invalid]="keyName.invalid && (keyName.touched || apiKeyForm.submitted)"
              [(ngModel)]="newApiKey.name"
              #keyName="ngModel"
              placeholder="Input here..."
              required
            />
            @if (keyName.invalid && (keyName.touched || apiKeyForm.submitted)) {
              <p-message severity="error" size="small" variant="simple">
                @if (keyName.errors['required']) {
                  Key name is required.
                }
              </p-message>
            }
          </div>
        </div>
      </div>
      <p-divider />
      <div class="p-5">
        <div class="grid grid-cols-3 w-full gap-12">
          <label for="description" class="col-span-1">
            <p class="font-medium text-sm">Permissions</p>
          </label>
          <div class="flex flex-col gap-8 col-span-2">
            <div class="flex gap-4">
              <p-checkbox
                id="restApiPermission"
                [(ngModel)]="newApiKey.scopes.rest"
                [ngModelOptions]="{ standalone: true }"
                [binary]="true"
                size="large"
              />
              <div>
                <label for="restApiPermission" class="text-sm">REST API Access</label>
                <p class="text-surface-500 text-xs">
                  Enable this to allow the API key to access and manage data via the system’s
                  RESTful API.
                </p>
              </div>
            </div>
            <div class="flex gap-4">
              <p-checkbox
                id="agentApiPermission"
                [(ngModel)]="newApiKey.scopes.agent"
                [ngModelOptions]="{ standalone: true }"
                [binary]="true"
                size="large"
              />
              <div>
                <label for="agentApiPermission" class="text-sm">Agent API Access</label>
                <p class="text-surface-500 text-xs">
                  Enable this to allow the API key to access and manage data via the system’s Agent
                  API.
                </p>
              </div>
            </div>
            <div class="flex gap-4">
              <p-checkbox
                id="mcpServerPermission"
                [(ngModel)]="newApiKey.scopes.mcp"
                [ngModelOptions]="{ standalone: true }"
                [binary]="true"
                size="large"
              />
              <div>
                <label for="mcpServerPermission" class="text-sm">MCP Server Access</label>
                <p class="text-surface-500 text-xs">
                  Enable this to allow the API key to access and manage data via the system’s MCP
                  Server.
                </p>
              </div>
            </div>
            <div class="flex gap-4">
              <p-checkbox
                id="realtimeServerPermission"
                [(ngModel)]="newApiKey.scopes.realtime"
                [ngModelOptions]="{ standalone: true }"
                [binary]="true"
                size="large"
              />
              <div>
                <label for="realtimeServerPermission" class="text-sm">Realtime Server Access</label>
                <p class="text-surface-500 text-xs">
                  Enable this to allow the API key to access and manage data via the system’s
                  Realtime Server.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </ng-template>
  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" severity="secondary" (click)="isCreationMode = false" />
      <button
        pButton
        label="Save"
        [loading]="isCreating()"
        [disabled]="apiKeyForm().invalid"
        type="submit"
        form="apiKeyForm"
      ></button>
    </div>
  </ng-template>
</p-drawer>

<div class="py-10 max-w-280 mx-auto">
  <div class="flex justify-between items-center mb-8">
    <div>
      <div class="text-xl">API Key Management</div>
      <p class="text-sm text-gray-500">
        Manage your API keys, view details, and perform actions such as copying keys or adding new
        ones.
      </p>
    </div>
    <p-button label="Add Key" icon="icon icon-plus" (click)="isCreationMode = true" />
  </div>

  <div class="mb-4">
    <p-iconfield>
      <p-inputicon class="icon icon-search" />
      <input
        class="w-70"
        type="text"
        pInputText
        placeholder="Search key..."
        [(ngModel)]="searchQuery"
        (input)="searchByName()"
      />
    </p-iconfield>
  </div>

  <p-table [value]="filteredKeys()" [paginator]="true" [rows]="10" [showCurrentPageReport]="true">
    <ng-template pTemplate="header">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Key</th>
        <th>Scopes</th>
        <th>Created At</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-key>
      <tr>
        <td>{{ key.id }}</td>
        <td>{{ key.name }}</td>
        <td>
          <div class="flex items-center gap-2">
            <code class="text-sm truncate">{{ key.key | slice: 0 : 10 }}...</code>
            <p-button
              icon="icon icon-copy"
              severity="secondary"
              [text]="true"
              [pTooltip]="'Copy to clipboard'"
              tooltipPosition="top"
              [cdkCopyToClipboard]="key.key"
              (cdkCopyToClipboardCopied)="onCopyKey()"
            />
          </div>
        </td>
        <td>
          <div class="flex flex-wrap gap-1">
            @if (key.scopes.rest) {
              <p-tag severity="secondary" value="rest" />
            }
            @if (key.scopes.agent) {
              <p-tag severity="secondary" value="agent" />
            }
            @if (key.scopes.mcp) {
              <p-tag severity="secondary" value="mcp" />
            }
            @if (key.scopes.realtime) {
              <p-tag severity="secondary" value="realtime" />
            }
          </div>
        </td>
        <td>{{ key.createdAt | date: 'medium' }}</td>
        <td>
          <p-tag
            [value]="key.revoked ? 'Revoked' : 'Active'"
            [severity]="key.revoked ? 'danger' : 'success'"
          />
        </td>
        <td>
          @if (!key.revoked) {
            <p-button
              icon="icon icon-trash"
              severity="danger"
              [text]="true"
              [pTooltip]="'Revoke key'"
              tooltipPosition="top"
              (click)="revokeKey(key)"
            />
          }
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="!text-center py-5">No API Keys found</td>
      </tr>
    </ng-template>
  </p-table>
</div>
